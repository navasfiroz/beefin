<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Location Radius Check</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Ubuntu;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    .card {
      max-width: 420px;
      width: 100%;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 28px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
    }
    h1 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    p {
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 20px;
    }
    button {
      background: #ffdd00;
      color: #292929;
      border: none;
      padding: 12px 18px;
      font-size: 15px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      opacity: 0.9;
    }
    .result {
      margin-top: 20px;
      font-size: 15px;
      font-weight: 600;
    }
    .inside { color: #16a34a; }
    .outside { color: #dc2626; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Check Your Availability</h1>
    <p>We need your location to check if you're within our service area.</p>
    <button onclick="getLocation()">Allow Location Access</button>
    <div id="result" class="result"></div>
  </div>

  <script>
    // ===== CONFIG =====
    const STORE_LAT = 9.1326103;  // example latitude
    const STORE_LON = 76.5133728; // example longitude
    const MAX_DISTANCE_KM = 10;

    function getLocation() {
      if (!navigator.geolocation) {
        showResult('Geolocation is not supported by your browser.', 'outside');
        return;
      }

      showResult('Checking your locationâ€¦', '');

      // First attempt: high accuracy (GPS)
      navigator.geolocation.getCurrentPosition(
        onSuccess,
        onErrorHighAccuracy,
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    }

    function onSuccess(position) {
      const userLat = position.coords.latitude;
      const userLon = position.coords.longitude;
      const distance = calculateDistance(userLat, userLon, STORE_LAT, STORE_LON);

      if (distance <= MAX_DISTANCE_KM) {
        showResult(`You're within ${distance.toFixed(2)} km. You're eligible!`, 'inside');
      } else {
        showResult(`You're ${distance.toFixed(2)} km away. Outside our service area.`, 'outside');
      }
    }

    let fallbackAttempted = false;

    function onErrorHighAccuracy(error) {
      // iOS often throws POSITION_UNAVAILABLE / kCLErrorLocationUnknown here
      if (fallbackAttempted) return;
      fallbackAttempted = true;

      setTimeout(() => {
        navigator.geolocation.getCurrentPosition(
          onSuccess,
          onErrorLowAccuracy,
          { enableHighAccuracy: false, timeout: 20000, maximumAge: 60000 }
        );
      }, 1200);
    }

    function onErrorLowAccuracy(error) {
      let msg = 'Unable to fetch location.';
      if (error.code === error.PERMISSION_DENIED) msg = 'You denied location access.';
      if (error.code === error.POSITION_UNAVAILABLE) msg = 'Location unavailable. Try moving outdoors.';
      if (error.code === error.TIMEOUT) msg = 'Location request timed out. Please retry.';
      showResult(msg, 'outside');
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function toRad(value) {
      return (value * Math.PI) / 180;
    }

    function showResult(message, className) {
      const el = document.getElementById('result');
      el.textContent = message;
      el.className = `result ${className}`;
    }
  </script>
</body>
</html>
